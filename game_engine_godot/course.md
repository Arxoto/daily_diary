# Godot 4 教程《勇者传说》

from https://www.bilibili.com/video/BV1Z94y1V74m

基于 Godot v4.4 的一个像素风横板动作游戏制作指南

## 基础项目、测试场景、简单人物

像素风游戏的常用配置（画面放大三倍）

- 左上角-项目-项目设置
- 打开右上角高级设置-显示-窗口
  1. 窗口宽度高度覆盖调整至视口大小
  1. 视口大小调整至原来的 1/3 （直接在后面输入/3能自动计算）
  1. 拉伸-模式 选择 canvas_items
- 左上角-编辑器-编辑器设置-文本编辑器-补全-启动【添加类型提示】

添加世界

- 场景-创建根节点处，创建【2D场景】，重命名为【World】
- 添加子节点，类型【TileMap】
- 右侧检查器-【TileMap】-【TileSet】-新建【TileSet】
- 点击刚刚创建的【TileSet】展开
- 展开【PhysicsLayers】，点击添加元素
- 底部【TileSet】面板
- 将图片资源拖入面板里的【图块】
- 若有弹框提示：施放自动在不透明纹理区域创建图块，选择否
- 在基础图块中选择想要使用的图块
- 工作区中间的绘制工具-绘制属性【物理层0】-涂抹对应图块标识物理碰撞
- 底部【TileMap】面板可选中图块在上面画布中绘画地图（左键绘制、右键擦除、Shift画直线、Ctrl画布中获取图块）

添加人物

- 上方添加新场景-根节点选择其他节点-【CharacterBody2D】-改名Player
- 添加子节点【Sprite2D】用来显示图像
  - 将人物动作关键帧的图片（一般所有动作在一个图中）拖入右侧【Texture】
  - 左上角-项目-项目设置-渲染-纹理-默认纹理过滤-【Nearest】（像素风的清晰化）
  - 右侧检查器-Region-Enabled（将一个图划分成多个区域）-编辑区域
  - 左上角吸附模式-栅格吸附-调整步长-将一连串动作帧选中
  - 右侧检查器-Animation-Hframes（水平帧）调整对应值使其显示为一个动作帧（之后就可以使用Frame属性自动显示对应帧了）
- 添加子节点【CollisionShape2D】用来定义碰撞形状
  - 右侧检查器-Shape-选择【新建RectangleShape2D】创建矩形碰撞箱
- 添加子节点【AnimationPlayer】用来定义动画（用来控制其他子节点的各项属性如何根据时间轴改变）
  - 下方工作区-动画-创建新动画
  - 工作区的上方右侧调整总长度和打开循环
  - 切换到【Sprite2D】节点，将一下属性新建轨道并插入关键帧
    - Region-Rect 因为不同动画的区域范围可能会不一样
    - Animation-Hframes 因为不同的动画（动作集）的Hframes可能会不一样
    - Frame 需要将对应动作帧依次加入，注意工作区的下面【吸附】调整对应的每帧时间，像素游戏可以0.1秒1帧
    - 注意要保持所有动画的轨道一致，不然会有状态残留导致各种BUG
- 根节点添加脚本自定义控制逻辑
  - 注意物理引擎相关的逻辑写在 _physics_process 方法中
  - 根据重力下降
  - 根据输入移动 
    - 项目-项目设置-输入映射页签
    - 添加自定义的输入按键和对应的动作名称
    - 右侧加号配置监听的按键事件
    - 脚本中使用 Input 类的方法获取输入
  - 若要脚本中控制对应子节点
    - 拖动对应子节点
    - 摁住 Ctrl 然后松开鼠标左键，能自动为节点创建变量
    - 如使用 AnimationPlayer 的 play 方法播放动画
    - 如控制 Sprite2D 的 flip_h 属性控制水平翻转
- 在世界根节点上实例化子场景-选择player添加实例

## 相机

此时看到的画面不会随人物移动，测试场景较大的情况下，人物会跑出画面，因此需要设置相机

- 世界中的Player节点-添加子节点-Camera2D（因为要让相机跟随人物移动）
- 拖动相机框的准心调整相对位置（Ctrl键方便对齐）
- 右侧检查器-Drag-启动【Horizontal】和【Vertical】打开水平垂直拖拽效果
- 右侧检查器-PositionSmoothing-启用位置平滑
- 为防止相机看到场景以外的空白，可设置【Limit】属性，并打开【Smoothed】平滑效果
- 也可以在World根节点的脚本 _ready 里根据TileMap的矩形框的范围动态设定限制（注意单位是像素和TileSet元素个数的单位转换）
  - 注意方法的生命周期，在 _ready 里设置 limit 的时候若相机已经超出了限制区域，会场景开始时就触发平滑移动
  - 可在方法最后使用 reset_smoothing 方法在一帧内快速达到平滑移动的目的地

## 地形编辑

此时测试环境较为简略，本章简单介绍了几种 TileMap 使用方式，搭建较为完整的场景

- 在下方工作区 TileSet 选中要使用的各个元素
- 若元素向边缘有拓展
  - 中间的选择工具，选中对应图块，使用四周的小圆圈进行拓展
  - 配置中心位置（图块的中心）：选择工具-渲染-纹理原点
  - 配置中心位置（批量方式）：绘制工具-绘制属性【渲染】-纹理原点-调整后拖动即可

此时基本具备绘制场景的能力，但需要手动选择对应图块，效率很低，可以使用地形工具

地形能根据图块所在的相对位置自动选择显示哪种图块

- 右边检查器-【TileSet】展开-【TerrainSets】-添加元素添加一个地形集
- 选择【MatchCorners】即根据角落进行匹配
- 【Terrains】-添加元素添加一个实际地形
- 【Name】命名一个有意义的名称（大地/树干/岩浆等等）
- 工作区-【TileSet】-绘制工具-【绘制属性】地形-【地形集】选择刚刚创建的地形集
- Ctrl+Shift 进行拖动，将对应图块添加到地形中
- 绘制工具-【地形】选择刚刚创建的地形名称-为每个图块设置临界图块的匹配规则
- Ctrl+Shift 进行拖动，批量设置规则
- 工作区-【TileMap】-地形页签-选中对应的地形名称
- 可在地形编辑器中批量绘制 Ctrl+Shift 多个方块进行组合绘制
- 地形图块默认每个图块出现的比例是相同的，想要定制概率
  - 工作区-【TileSet】-绘制工具-【绘制属性】概率

图块进阶

- 若想在几个图块中随机选中图块进行绘制
  - 图块中 Shift 同时选中多个图块
  - 工作区上方的骰子点亮即可
- 若想批量操作，让选中的图块中随机选择几个图块进行绘制
  - 调整散布属性（图块默认概率为1，散布的值即为空白的概率，如：散布值为2，那么空白:图块1:图块2:...=2:1:1:...）
- 若想调整图块与扩展图块间的优先级，可使用 TileMap 的图层功能
  - 检查器-Layers-添加元素为各个图层命名
  - 工作区上方右边选择对应图层
  - 切换对应图层即在地形编辑器的对应图层中绘制（所以叫做 TileMap 的图层功能）
  - 一般图层至少分为：背景、物理碰撞层、前景

## 视差背景
